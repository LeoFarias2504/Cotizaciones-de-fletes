<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freddo Comex - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans">

    <div class="max-w-4xl mx-auto mb-6 flex justify-center space-x-4">
        <button id="btnForm" onclick="toggleView('form')" class="px-6 py-2 rounded-full font-bold bg-blue-900 text-white shadow transition transform hover:scale-105">
            + Cargar Cotización
        </button>
        <button id="btnDash" onclick="toggleView('dash')" class="px-6 py-2 rounded-full font-bold bg-white text-blue-900 shadow transition transform hover:scale-105">
            Ver Dashboard y Gráficos
        </button>
    </div>

    <div id="formSection" class="bg-white shadow-xl rounded-xl p-8 w-full max-w-2xl mx-auto border-t-4 border-blue-900">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Nueva Cotización</h2>
            <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded">FREDDO COMEX</span>
        </div>

        <form id="comexForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" name="referencia" class="border p-3 rounded bg-gray-50" placeholder="Ref. Expo (ej: 001)" required>
            
            <input type="text" name="destino" list="destinosList" class="border p-3 rounded bg-gray-50" placeholder="Destino (País)" required>
            <datalist id="destinosList">
                <option value="Uruguay"><option value="Chile"><option value="Brasil"><option value="USA"><option value="Colombia"><option value="Perú"><option value="Mexico">
            </datalist>

            <select name="modalidad" class="border p-3 rounded bg-gray-50">
                <option value="Marítimo">Marítimo</option><option value="Terrestre">Terrestre</option><option value="Aéreo">Aéreo</option>
            </select>

            <input type="text" name="incoterm" class="border p-3 rounded bg-gray-50" placeholder="Incoterm">

            <select name="contenedor" class="border p-3 rounded bg-gray-50" required>
                <option value="" disabled selected>Tipo Contenedor...</option>
                <option value="20 pies ST">20 pies ST</option><option value="40 pies ST">40 pies ST</option>
                <option value="40 HC">40 HC</option><option value="20 RF">20 RF (Reefer)</option>
                <option value="40 RF">40 RF (Reefer)</option><option value="Sider">Sider</option>
            </select>

            <input type="text" name="carrier" class="border p-3 rounded bg-gray-50" placeholder="Naviera / Carrier" required>
            <input type="number" name="transit_time" class="border p-3 rounded bg-gray-50" placeholder="Transit Time (días)">
            <input type="number" step="0.01" name="flete" class="border p-3 rounded bg-gray-50" placeholder="Flete (USD)" required>
            <input type="number" step="0.01" name="gastos_locales" class="md:col-span-2 border p-3 rounded bg-gray-50" placeholder="Gastos Locales (USD)" required>

            <button type="submit" id="submitBtn" class="md:col-span-2 bg-blue-900 text-white font-bold py-3 rounded hover:bg-blue-800 transition">
                GUARDAR DATOS
            </button>
        </form>
        <p id="msg" class="mt-4 text-center text-green-600 hidden font-bold">¡Guardado con éxito!</p>
    </div>

    <div id="dashboardSection" class="hidden max-w-5xl mx-auto space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                <h3 class="text-gray-500 text-sm">Cotizaciones Registradas</h3>
                <p id="totalCount" class="text-3xl font-bold text-gray-800">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                <h3 class="text-gray-500 text-sm">Costo Promedio Global</h3>
                <p id="avgCostGlobal" class="text-3xl font-bold text-gray-800">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-500">
                <h3 class="text-gray-500 text-sm">Destino Más Frecuente</h3>
                <p id="topDest" class="text-3xl font-bold text-gray-800">-</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Costo Total Promedio (USD) por Destino</h3>
                <canvas id="costChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Transit Time Promedio (Días)</h3>
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <div class="text-center">
            <button onclick="loadDashboardData()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm hover:bg-gray-300">
                ↻ Actualizar Gráficos
            </button>
        </div>
    </div>

    <script>
        // ================= CONFIGURACIÓN =================
        const scriptURL = https://script.google.com/macros/library/d/1oca7cD2NNxiqZV10yUTh3Dw9JfCuYGQZkIEtQB5m3qdpnOU8q35XGbN4/1; 
        // =================================================

        // Lógica de Vistas (Tabs)
        function toggleView(view) {
            if (view === 'form') {
                document.getElementById('formSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
                document.getElementById('btnForm').classList.add('bg-blue-900', 'text-white');
                document.getElementById('btnForm').classList.remove('bg-white', 'text-blue-900');
                document.getElementById('btnDash').classList.remove('bg-blue-900', 'text-white');
                document.getElementById('btnDash').classList.add('bg-white', 'text-blue-900');
            } else {
                document.getElementById('formSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('btnDash').classList.add('bg-blue-900', 'text-white');
                document.getElementById('btnDash').classList.remove('bg-white', 'text-blue-900');
                document.getElementById('btnForm').classList.remove('bg-blue-900', 'text-white');
                document.getElementById('btnForm').classList.add('bg-white', 'text-blue-900');
                loadDashboardData(); // Cargar datos al abrir pestaña
            }
        }

        // Lógica de Envío (Guardar)
        const form = document.getElementById('comexForm');
        form.addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = 'Guardando...';
            
            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(r => {
                    document.getElementById('msg').classList.remove('hidden');
                    form.reset();
                    btn.disabled = false; btn.innerText = 'GUARDAR DATOS';
                    setTimeout(() => document.getElementById('msg').classList.add('hidden'), 3000);
                })
                .catch(err => alert('Error: ' + err));
        });

        // ================= LÓGICA DEL DASHBOARD =================
        let myCostChart = null;
        let myTimeChart = null;

        async function loadDashboardData() {
            try {
                const response = await fetch(scriptURL);
                const data = await response.json();
                processAndRender(data);
            } catch (error) {
                console.error("Error cargando datos", error);
            }
        }

        function processAndRender(rows) {
            // Estructura de datos: [Fecha, Ref, Destino, Mod, Incoterm, Cont, Carrier, TT, Flete, Gastos]
            // Índices: Destino=2, TT=7, Flete=8, Gastos=9
            
            const stats = {};

            rows.forEach(row => {
                let dest = row[2]; // País
                let tt = parseFloat(row[7]) || 0;
                let cost = (parseFloat(row[8]) || 0) + (parseFloat(row[9]) || 0); // Flete + Gastos

                if (!stats[dest]) {
                    stats[dest] = { totalCost: 0, totalTime: 0, count: 0 };
                }
                stats[dest].totalCost += cost;
                stats[dest].totalTime += tt;
                stats[dest].count++;
            });

            // Preparar arrays para Charts.js
            const labels = Object.keys(stats);
            const avgCosts = labels.map(d => (stats[d].totalCost / stats[d].count).toFixed(2));
            const avgTimes = labels.map(d => (stats[d].totalTime / stats[d].count).toFixed(1));

            // Actualizar Tarjetas KPI
            document.getElementById('totalCount').innerText = rows.length;
            let grandTotal = 0; rows.forEach(r => grandTotal += (parseFloat(r[8])||0) + (parseFloat(r[9])||0));
            document.getElementById('avgCostGlobal').innerText = rows.length ? `$${(grandTotal/rows.length).toFixed(0)}` : 0;
            
            // Renderizar Gráfico de Costos
            const ctxCost = document.getElementById('costChart').getContext('2d');
            if(myCostChart) myCostChart.destroy();
            myCostChart = new Chart(ctxCost, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Costo Promedio (Flete + Gastos)',
                        data: avgCosts,
                        backgroundColor: '#1e3a8a', // Azul Freddo
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // Renderizar Gráfico de Tiempos
            const ctxTime = document.getElementById('timeChart').getContext('2d');
            if(myTimeChart) myTimeChart.destroy();
            myTimeChart = new Chart(ctxTime, {
                type: 'line', // Línea para ver tendencias o diferencias
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Días de Tránsito (Promedio)',
                        data: avgTimes,
                        borderColor: '#10b981', // Verde
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true }
            });
        }
    </script>
</body>
</html>
