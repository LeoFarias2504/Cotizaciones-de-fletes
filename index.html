<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freddo Comex - Sistema de Gesti√≥n Log√≠stica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans text-slate-800">

    <div class="mb-6 bg-white p-5 rounded-xl shadow border-l-8 border-blue-900 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-blue-900 uppercase tracking-tight">
                <i class="fa-solid fa-ship mr-2"></i>Freddo <span class="text-blue-500"></span>
            </h1>
            <p class="text-xs text-gray-500 font-bold mt-1 uppercase">Cotizaciones de fletes</p>
        </div>
        <div class="text-right">
            <div class="text-xs font-bold bg-gray-200 px-3 py-1 rounded text-gray-600">
                <i class="fa-solid fa-user-tie mr-1"></i> Perfil: Supply Chain
            </div>
        </div>
    </div>

    <div id="errorArea" class="hidden mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow">
        <p class="font-bold"><i class="fa-solid fa-triangle-exclamation"></i> Mensaje del Sistema:</p>
        <p id="errorMessage" class="text-sm mt-1">...</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        
        <div class="w-full lg:w-1/3 h-fit bg-white rounded-xl shadow-lg border-t-4 border-blue-600 p-6">
            <h2 class="text-sm font-bold text-gray-700 mb-4 uppercase border-b pb-2">
                <i class="fa-solid fa-plus-circle mr-2"></i>Nueva Cotizaci√≥n
            </h2>
            
            <form id="comexForm" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Referencia Expo (√önica)</label>
                    <input type="text" name="referencia" class="w-full border border-gray-300 bg-gray-50 p-2 rounded text-sm focus:ring-2 focus:ring-blue-900 outline-none" placeholder="Ej: EXP-001" required>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Destino</label>
                        <input type="text" name="destino" list="destinosList" class="w-full border p-2 rounded text-sm bg-gray-50" placeholder="Pa√≠s" required>
                        <datalist id="destinosList">
                            <option value="Uruguay"><option value="Chile"><option value="Paraguay"><option value="Brasil"><option value="USA"><option value="Europa">
                        </datalist>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Modalidad</label>
                        <select id="modalidadSelect" name="modalidad" onchange="updateEquipment()" class="w-full border p-2 rounded text-sm bg-blue-50 font-semibold text-blue-900 outline-none">
                            <option value="Mar√≠timo">Mar√≠timo</option>
                            <option value="Terrestre">Terrestre</option>
                            <option value="A√©reo">A√©reo</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Incoterm</label>
                        <input type="text" name="incoterm" class="w-full border p-2 rounded text-sm bg-gray-50" placeholder="FCA/CIP/FOB" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Equipo / Carga</label>
                        <select id="equipoSelect" name="contenedor" class="w-full border p-2 rounded text-sm bg-gray-50 outline-none" required>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Proveedor Log√≠stico</label>
                    <input type="text" name="carrier" class="w-full border p-2 rounded text-sm bg-gray-50" placeholder="Naviera, Transportista o Forwarder" required>
                </div>

                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Estructura de Costos</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Transit Time</label>
                            <input type="number" name="transit_time" class="w-full border p-1 rounded text-sm" placeholder="D√≠as">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Flete USD</label>
                            <input type="number" step="0.01" name="flete" class="w-full border p-1 rounded text-sm font-bold text-gray-700" placeholder="0.00" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Gastos Loc. USD</label>
                            <input type="number" step="0.01" name="gastos_locales" class="w-full border p-1 rounded text-sm" placeholder="0.00" required>
                        </div>
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-blue-900 text-white font-bold py-3 rounded hover:bg-blue-800 transition shadow">
                    <i class="fa-solid fa-save mr-2"></i> GUARDAR EN BASE
                </button>
                <p id="statusMsg" class="hidden text-center text-xs font-bold text-green-600 mt-2">‚úÖ Registro Exitoso</p>
            </form>
        </div>

        <div class="w-full lg:w-2/3 space-y-5">
            
            <div class="bg-white p-3 rounded-xl shadow flex items-center justify-between border-l-4 border-orange-500">
                <span class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-filter mr-2"></i>Filtrar An√°lisis por Destino:</span>
                <select id="filterCountry" onchange="applyFilter()" class="border bg-orange-50 text-orange-900 font-bold rounded p-1 text-sm outline-none">
                    <option value="ALL">üåé Vista Global</option>
                </select>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow text-center">
                    <p class="text-xs text-gray-400 font-bold uppercase">Embarques</p>
                    <p id="kpiCount" class="text-xl font-bold text-blue-900">-</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow text-center">
                    <p class="text-xs text-gray-400 font-bold uppercase">Costo Promedio</p>
                    <p id="kpiAvgCost" class="text-xl font-bold text-green-600">-</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow text-center">
                    <p class="text-xs text-gray-400 font-bold uppercase">TT Promedio</p>
                    <p id="kpiAvgTime" class="text-xl font-bold text-indigo-600">-</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow text-center">
                    <p class="text-xs text-gray-400 font-bold uppercase">Opci√≥n Top</p>
                    <p id="kpiTop" class="text-sm font-bold text-gray-800 truncate">-</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-64">
                <div class="bg-white p-4 rounded-xl shadow border border-gray-100 relative">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 text-center">Comparativa Costos (USD)</h3>
                    <div class="h-48"><canvas id="costChart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border border-gray-100 relative">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 text-center">Comparativa Tiempos (D√≠as)</h3>
                    <div class="h-48"><canvas id="timeChart"></canvas></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden border border-gray-200">
                <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-600 uppercase"><i class="fa-solid fa-list mr-2"></i>Hist√≥rico (Detalle)</h3>
                    
                    <button id="btnDownload" onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-3 py-1.5 rounded transition shadow flex items-center">
                        <i class="fa-solid fa-file-excel mr-2"></i> Exportar
                    </button>
                </div>
                <div class="overflow-x-auto max-h-60 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">Fecha</th>
                                <th class="px-4 py-2">Ref</th>
                                <th class="px-4 py-2">Destino</th>
                                <th class="px-4 py-2">Carrier</th>
                                <th class="px-4 py-2 text-right">Total USD</th>
                                <th class="px-4 py-2 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="text-gray-600">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded shadow-xl text-center">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
                    <p class="font-bold">Procesando...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // URL DE APPS SCRIPT
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyxMBikAD1YkmTh3y4f90ErfUV63FBu4K3UevfrE0t7T0LJ3OFRBWXuBZhmCvEtfRYaYg/exec';
        // ==========================================

        let rawData = [];
        let filteredData = []; 
        let chartCost = null;
        let chartTime = null;

        const equipmentOptions = {
            "Mar√≠timo": ["20' Standard", "40' Standard", "40' High Cube", "20' Reefer", "40' Reefer"],
            "Terrestre": ["Cami√≥n Completo (FTL)", "Consolidado (LTL)", "Sider (Lonas)", "Furg√≥n Refrigerado"],
            "A√©reo": ["Carga General", "Carga Perecedera", "Muestras"]
        };

        function showError(msg) {
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorMessage').innerText = msg;
        }

        function updateEquipment() {
            const mode = document.getElementById('modalidadSelect').value;
            const select = document.getElementById('equipoSelect');
            select.innerHTML = ""; 
            equipmentOptions[mode].forEach(opt => {
                let el = document.createElement("option"); el.value = opt; el.innerText = opt; select.appendChild(el);
            });
        }

        window.onload = () => { 
            updateEquipment(); 
            if(typeof XLSX === 'undefined') {
                document.getElementById('btnDownload').disabled = true;
                document.getElementById('btnDownload').classList.add('bg-gray-400');
            }
            loadDashboard(); 
        };

        const form = document.getElementById('comexForm');
        form.addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('statusMsg');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';

            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(response => { if (!response.ok) throw new Error("Error de red"); return response; })
                .then(() => {
                    msg.classList.remove('hidden');
                    form.reset();
                    updateEquipment();
                    loadDashboard(); 
                    setTimeout(() => { msg.classList.add('hidden'); btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> GUARDAR EN BASE'; }, 2000);
                })
                .catch(err => {
                    alert("Error al guardar: " + err);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> GUARDAR EN BASE';
                });
        });

        // NUEVA FUNCI√ìN DE BORRADO
        function deleteRecord(referencia) {
            if(!confirm(`¬øEst√°s seguro de que quieres eliminar la referencia ${referencia} del sistema?`)) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');

            // Creamos un FormData especial para la acci√≥n de borrar
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('referencia', referencia);

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    if (data.result === "deleted") {
                        alert("Registro eliminado correctamente.");
                        loadDashboard(); // Recargar todo
                    } else {
                        alert("No se pudo borrar. Es posible que la referencia no exista o ya haya sido borrada.");
                    }
                })
                .catch(err => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    alert("Error de conexi√≥n al borrar: " + err);
                });
        }

        async function loadDashboard() {
            try {
                const res = await fetch(scriptURL);
                if (!res.ok) throw new Error("No se pudo conectar con Google Sheets");
                const json = await res.json();
                rawData = json;
                populateFilter();
                applyFilter();
            } catch (e) { showError("Error al cargar datos: " + e.message); }
        }

        function populateFilter() {
            if(!rawData || !rawData.length) return;
            const select = document.getElementById('filterCountry');
            const current = select.value;
            const countries = [...new Set(rawData.map(r => r[2]).filter(x => x))].sort();
            select.innerHTML = '<option value="ALL">üåé Vista Global</option>';
            countries.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
            select.value = current;
        }

        function applyFilter() {
            if(!rawData || !rawData.length) return;
            const country = document.getElementById('filterCountry').value;
            filteredData = (country === "ALL") ? rawData : rawData.filter(r => r[2] === country);

            const stats = {};
            let totalCost = 0, totalTime = 0, countTime = 0;

            filteredData.forEach(r => {
                if (!r || r.length < 10) return;
                let key = (country === "ALL") ? (r[2] || "S/D") : (r[6] || "S/D"); 
                let cost = (parseFloat(r[8])||0) + (parseFloat(r[9])||0);
                let tt = parseFloat(r[7])||0;

                if(!stats[key]) stats[key] = { costSum: 0, timeSum: 0, count: 0 };
                stats[key].costSum += cost;
                stats[key].timeSum += tt;
                stats[key].count++;
                totalCost += cost;
                if(tt>0) { totalTime += tt; countTime++; }
            });

            document.getElementById('kpiCount').innerText = filteredData.length;
            document.getElementById('kpiAvgCost').innerText = filteredData.length ? `$${(totalCost/filteredData.length).toFixed(0)}` : "0";
            document.getElementById('kpiAvgTime').innerText = countTime ? (totalTime/countTime).toFixed(1) + "d" : "-";
            let topKey = Object.keys(stats).length ? Object.keys(stats).reduce((a, b) => stats[a].count > stats[b].count ? a : b) : '-';
            document.getElementById('kpiTop').innerText = topKey;

            renderCharts(Object.keys(stats), Object.keys(stats).map(k => (stats[k].costSum / stats[k].count).toFixed(0)), Object.keys(stats).map(k => (stats[k].timeSum / stats[k].count).toFixed(1)), country !== "ALL");
            renderTable(filteredData);
        }

        function renderCharts(labels, costs, times, isByCarrier) {
            if(chartCost) chartCost.destroy();
            if(chartTime) chartTime.destroy();
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

            chartCost = new Chart(document.getElementById('costChart'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Costo Promedio (USD)', data: costs, backgroundColor: isByCarrier ? '#f97316' : '#1e3a8a', borderRadius: 4 }] },
                options: commonOptions
            });

            chartTime = new Chart(document.getElementById('timeChart'), {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'TT Promedio (D√≠as)', data: times, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] },
                options: commonOptions
            });
        }

        function renderTable(rows) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = "";
            rows.slice().reverse().slice(0, 50).forEach(r => {
                let dateStr = '-';
                try { dateStr = r[0] ? new Date(r[0]).toLocaleDateString() : '-'; } catch(e){}
                const total = (parseFloat(r[8])||0) + (parseFloat(r[9])||0);
                
                // NOTA: r[1] es la Referencia. Se usa para identificar qu√© borrar.
                const referencia = r[1] || "";

                const tr = `
                    <tr class="bg-white border-b hover:bg-gray-50 group">
                        <td class="px-4 py-2 font-medium">${dateStr}</td>
                        <td class="px-4 py-2 text-xs font-bold text-gray-700">${referencia}</td>
                        <td class="px-4 py-2">${r[2] || ''}</td>
                        <td class="px-4 py-2 text-xs truncate max-w-[100px]">${r[6] || ''}</td>
                        <td class="px-4 py-2 text-right font-bold text-green-700">$${total.toFixed(2)}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="deleteRecord('${referencia}')" class="text-gray-400 hover:text-red-600 transition" title="Eliminar Registro">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                tbody.innerHTML += tr;
            });
        }

        function downloadExcel() {
            if (typeof XLSX === 'undefined') { alert("Error: Librer√≠a Excel no cargada."); return; }
            if (!filteredData || filteredData.length === 0) { alert("No hay datos para exportar."); return; }

            const excelData = filteredData.map(row => ({
                "Fecha": row[0] ? new Date(row[0]).toLocaleDateString() : '',
                "Referencia": row[1],
                "Destino": row[2],
                "Modalidad": row[3],
                "Incoterm": row[4],
                "Equipo": row[5],
                "Carrier": row[6],
                "Transit Time (D√≠as)": parseFloat(row[7]) || 0,
                "Flete (USD)": parseFloat(row[8]) || 0,
                "Gastos Locales (USD)": parseFloat(row[9]) || 0,
                "Costo Total (USD)": (parseFloat(row[8])||0) + (parseFloat(row[9])||0)
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte Comex");
            const countryName = document.getElementById('filterCountry').value;
            XLSX.writeFile(wb, `Reporte_Freddo_${countryName}.xlsx`);
        }
    </script>
</body>
</html>
    </script>
</body>
</html>
