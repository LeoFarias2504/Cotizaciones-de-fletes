<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freddo Comex - Control Tower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        
        /* Botones de NavegaciÃ³n */
        .nav-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            background: transparent;
        }
        .nav-btn:hover { color: #1e3a8a; background-color: #e2e8f0; }
        .nav-btn.active { color: #1e3a8a; border-bottom-color: #1e3a8a; background-color: #eff6ff; }

        /* Tablas y Cards */
        .clickable-row { cursor: pointer; transition: background-color 0.15s; }
        .clickable-row:hover { background-color: #dbeafe !important; }
        
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <nav class="bg-white shadow-md sticky top-0 z-50 px-6">
        <div class="flex justify-between items-center h-16 max-w-screen-2xl mx-auto">
            <div class="flex items-center gap-6">
                <div class="flex items-center text-blue-900 text-2xl font-extrabold tracking-tight">
                    <i class="fa-solid fa-ship mr-3"></i>FREDDO <span class="text-blue-600 ml-1">COMEX</span>
                </div>
                
                <div class="flex space-x-1 h-16 items-end">
                    <button onclick="switchTab('cotizador')" id="btn-cotizador" class="nav-btn active"><i class="fa-solid fa-calculator mr-2"></i>Cotizador</button>
                    <button onclick="switchTab('2026')" id="btn-2026" class="nav-btn">2026</button>
                    <button onclick="switchTab('2025')" id="btn-2025" class="nav-btn">2025</button>
                    <button onclick="switchTab('2024')" id="btn-2024" class="nav-btn">2024</button>
                    <button onclick="switchTab('evolucion')" id="btn-evolucion" class="nav-btn text-purple-700 font-bold"><i class="fa-solid fa-chart-line mr-2"></i>EvoluciÃ³n</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="view-cotizador" class="p-6 max-w-screen-2xl mx-auto fade-in">
        <div class="flex flex-col lg:flex-row gap-6">
            
            <div class="w-full lg:w-1/3 bg-white rounded-xl shadow border-t-4 border-blue-600 p-6 h-fit">
                <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2"><i class="fa-solid fa-plus-circle mr-2"></i>Nueva CotizaciÃ³n</h2>
                <form id="comexForm" class="space-y-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Referencia</label><input type="text" name="referencia" class="w-full border p-2 rounded text-sm bg-gray-50" required placeholder="Ej: EXP-001"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Destino</label><input type="text" name="destino" list="destinosList" class="w-full border p-2 rounded text-sm" required><datalist id="destinosList"><option value="Uruguay"><option value="Chile"><option value="Paraguay"><option value="Brasil"><option value="USA"><option value="Mexico"></datalist></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Modalidad</label><select name="modalidad" id="modalidadSelect" onchange="updateEq()" class="w-full border p-2 rounded text-sm bg-white"><option value="MarÃ­timo">MarÃ­timo</option><option value="Terrestre">Terrestre</option><option value="AÃ©reo">AÃ©reo</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Incoterm</label><input type="text" name="incoterm" class="w-full border p-2 rounded text-sm" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Equipo</label><select name="contenedor" id="equipoSelect" class="w-full border p-2 rounded text-sm bg-white" required></select></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Carrier</label><input type="text" name="carrier" class="w-full border p-2 rounded text-sm" required></div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-100 grid grid-cols-3 gap-2">
                        <div><label class="text-[10px] font-bold text-gray-500">TT (DÃ­as)</label><input type="number" name="transit_time" class="w-full border p-1 rounded text-sm text-center bg-white"></div>
                        <div><label class="text-[10px] font-bold text-gray-500">Flete USD</label><input type="number" step="0.01" name="flete" class="w-full border p-1 rounded text-sm font-bold text-center bg-white" required></div>
                        <div><label class="text-[10px] font-bold text-gray-500">Gastos</label><input type="number" step="0.01" name="gastos_locales" class="w-full border p-1 rounded text-sm text-center bg-white" required></div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded transition shadow-lg">GUARDAR</button>
                </form>
            </div>

            <div class="w-full lg:w-2/3 space-y-6">
                <div class="bg-white p-4 rounded-xl shadow flex justify-between items-center border-l-4 border-orange-500">
                    <span class="font-bold text-gray-700">Filtro HistÃ³rico:</span>
                    <select id="filterCountry" onchange="applyFilter()" class="border bg-orange-50 text-orange-900 font-bold rounded px-3 py-1 text-sm outline-none"><option value="ALL">ðŸŒŽ Global</option></select>
                </div>
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow text-center border-b-4 border-blue-900 card-hover"><p class="text-xs text-gray-400 font-bold">OPS</p><p id="kpiCount" class="text-xl font-bold text-blue-900">-</p></div>
                    <div class="bg-white p-4 rounded-xl shadow text-center border-b-4 border-green-600 card-hover"><p class="text-xs text-gray-400 font-bold">COSTO AVG</p><p id="kpiAvgCost" class="text-xl font-bold text-green-600">-</p></div>
                    <div class="bg-white p-4 rounded-xl shadow text-center border-b-4 border-indigo-600 card-hover"><p class="text-xs text-gray-400 font-bold">TT AVG</p><p id="kpiAvgTime" class="text-xl font-bold text-indigo-600">-</p></div>
                    <div class="bg-white p-4 rounded-xl shadow text-center border-b-4 border-gray-500 card-hover"><p class="text-xs text-gray-400 font-bold">TOP</p><p id="kpiTop" class="text-xs font-bold text-gray-800 mt-2 truncate">-</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4 h-56">
                    <div class="bg-white p-4 rounded-xl shadow border card-hover"><canvas id="costChart"></canvas></div>
                    <div class="bg-white p-4 rounded-xl shadow border card-hover"><canvas id="timeChart"></canvas></div>
                </div>
                <div class="bg-white rounded-xl shadow overflow-hidden border">
                    <div class="overflow-x-auto max-h-64">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 bg-gray-100 sticky top-0"><tr><th class="px-4 py-2">Fecha</th><th class="px-4 py-2">Ref</th><th class="px-4 py-2">Destino</th><th class="px-4 py-2">Carrier</th><th class="px-4 py-2 text-right">Total</th></tr></thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-gestion" class="hidden p-6 max-w-screen-2xl mx-auto fade-in">
        <div class="flex justify-between items-center mb-6">
            <div><h2 class="text-2xl font-bold text-gray-800">GestiÃ³n <span id="lbl-year" class="text-blue-600">2026</span></h2><p class="text-sm text-gray-500">Panel Operativo y Packing List</p></div>
            <button onclick="openImportModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded shadow flex items-center transition"><i class="fa-solid fa-file-import mr-2"></i> Importar Excel (<span id="lbl-year-btn">2026</span>)</button>
        </div>

        <div class="bg-white p-4 rounded-xl shadow border mb-4 flex gap-4 items-center">
            <div class="flex items-center gap-3 w-1/2 bg-gray-50 px-3 py-2 rounded-lg border focus-within:border-blue-500 focus-within:bg-white transition">
                <i class="fa-solid fa-search text-gray-400"></i>
                <input type="text" id="skuInput" onkeyup="searchSKU()" placeholder="Buscar OperaciÃ³n, SKU, DescripciÃ³n..." class="w-full bg-transparent outline-none text-sm">
            </div>
            <div class="text-xs text-gray-400 ml-auto" id="db-status">Cargando...</div>
        </div>

        <div id="search-results" class="hidden bg-white rounded-xl shadow-xl border border-blue-200 mb-6 overflow-hidden relative z-20 max-h-80 overflow-y-auto">
            <div class="bg-blue-50 px-4 py-2 border-b flex justify-between sticky top-0"><h3 class="font-bold text-blue-900 text-sm">Resultados</h3><button onclick="closeSearch()"><i class="fa-solid fa-times text-gray-400"></i></button></div>
            <table class="w-full text-sm text-left"><thead class="text-xs text-gray-600 bg-gray-100"><tr><th class="p-2">Fecha</th><th class="p-2">Op</th><th class="p-2">Destino</th><th class="p-2">SKU</th><th class="p-2">Desc</th><th class="p-2 text-right">Kg</th></tr></thead><tbody id="search-body"></tbody></table>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-4 bg-white rounded-xl shadow h-[850px] flex flex-col border">
                <div class="p-4 border-b bg-gray-50"><label class="text-xs font-bold text-gray-500">FILTRAR DESTINO</label><select id="pl-filter-dest" onchange="renderList()" class="w-full mt-1 border rounded p-2 text-sm font-bold text-gray-700 outline-none"><option value="TODOS">Todos</option></select></div>
                <div id="pl-list" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50"></div>
            </div>
            <div class="col-span-12 md:col-span-8 space-y-6">
                <div class="flex justify-between items-center border-b pb-2">
                    <div><h3 id="dash-title" class="text-xl font-bold text-[#003366]">Resumen</h3><span id="dash-sub" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">General</span></div>
                    <button onclick="downloadExcelPL()" class="text-green-700 text-sm font-bold border border-green-200 px-3 py-1 rounded hover:bg-green-50"><i class="fa-solid fa-file-excel mr-2"></i>Descargar</button>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-900 card-hover"><p class="text-xs text-gray-400 font-bold">TOTAL USD</p><p id="kpi-usd" class="text-2xl font-bold text-blue-900">-</p></div>
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500 card-hover"><p class="text-xs text-gray-400 font-bold">TOTAL KG</p><p id="kpi-kg" class="text-2xl font-bold text-gray-800">-</p></div>
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-600 card-hover"><p class="text-xs text-gray-400 font-bold">ITEMS/OPS</p><p id="kpi-items" class="text-2xl font-bold text-gray-800">-</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4 h-64">
                    <div class="bg-white p-4 rounded-xl shadow border card-hover"><h4 class="text-xs font-bold text-center mb-2">Mix (USD)</h4><div class="h-48"><canvas id="chartType"></canvas></div></div>
                    <div class="bg-white p-4 rounded-xl shadow border card-hover"><h4 class="text-xs font-bold text-center mb-2" id="title-bar">Top 5</h4><div class="h-48"><canvas id="chartBar"></canvas></div></div>
                </div>
                <div class="grid grid-cols-2 gap-4 h-64">
                    <div class="bg-white p-4 rounded-xl shadow border card-hover"><h4 class="text-xs font-bold text-center mb-2">Mix (KG)</h4><div class="h-48"><canvas id="chartTypeKg"></canvas></div></div>
                    <div class="bg-white p-4 rounded-xl shadow border card-hover"><h4 class="text-xs font-bold text-center mb-2">Top 5 (KG)</h4><div class="h-48"><canvas id="chartBarKg"></canvas></div></div>
                </div>
                <div class="bg-white rounded-xl shadow overflow-hidden border">
                    <div class="overflow-x-auto max-h-80"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-600 bg-gray-100 sticky top-0"><tr>
                        <th class="p-2 cursor-pointer hover:bg-gray-200" onclick="sortT('fecha')">Fecha â†•</th>
                        <th class="p-2 cursor-pointer hover:bg-gray-200" onclick="sortT('sku')">SKU â†•</th>
                        <th class="p-2 cursor-pointer hover:bg-gray-200" onclick="sortT('desc')">Desc â†•</th>
                        <th class="p-2">Tipo</th>
                        <th class="p-2 text-right cursor-pointer hover:bg-gray-200" onclick="sortT('kg')">Kg â†•</th>
                        <th class="p-2 text-right cursor-pointer hover:bg-gray-200" onclick="sortT('usd')">USD â†•</th>
                    </tr></thead><tbody id="pl-table"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-evolucion" class="hidden p-6 max-w-screen-2xl mx-auto fade-in">
        <h2 class="text-2xl font-bold text-purple-800 mb-6">Comparativa Mensual (2024 - 2026)</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500 card-hover">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">Ventas Mensuales (USD)</h3><div class="text-xs text-gray-400">Comparativa Anual</div></div>
                <div class="h-72"><canvas id="evoChartUSD"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-orange-500 card-hover">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">Volumen Mensual (KG)</h3><div class="text-xs text-gray-400">Comparativa Anual</div></div>
                <div class="h-72"><canvas id="evoChartKG"></canvas></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border">
            <h3 class="font-bold text-gray-700 mb-4">Resumen Acumulado por AÃ±o (YTD)</h3>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-purple-50 text-purple-900 font-bold"><tr><th class="p-3">AÃ±o</th><th class="p-3 text-right">Total USD</th><th class="p-3 text-right">Total KG</th><th class="p-3 text-right">Promedio Mensual (USD)</th></tr></thead><tbody id="evoTableBody"></tbody></table></div>
        </div>
    </div>

    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="text-xl font-bold text-gray-800">Importar Datos: <span id="lbl-year-modal" class="text-blue-600"></span></h3><button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button></div>
            <p class="text-sm text-gray-600 mb-4">Copia las filas de tu Excel (AÃ±o correspondiente). <br><span class="text-red-500 font-bold">COLUMNAS:</span> NRO EXPO | DESTINO | TIPO | FECHA | ... | PRECIO TOTAL</p>
            <textarea id="paste-area" class="w-full h-48 border-2 border-dashed border-gray-300 rounded p-3 text-xs font-mono focus:border-blue-500 outline-none" placeholder="Pegar aquÃ­..."></textarea>
            <div class="mt-4 flex justify-end space-x-3"><button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded font-bold text-sm">Cancelar</button><button onclick="saveData()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold text-sm shadow hover:bg-blue-700">Guardar Datos</button></div>
        </div>
    </div>

    <div id="loader" class="hidden fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
        <i class="fa-solid fa-circle-notch fa-spin text-5xl text-blue-600 mb-4"></i>
        <p class="font-bold text-gray-700 text-lg">Procesando...</p>
    </div>

    <script>
        // =========================================================
        // ðŸš¨ URL DEL SCRIPT (NO TOCAR SI NO CAMBIA)
        // =========================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzSNd1a7uNIVV3YZYC7j3735Jo-H_qVgjGJ6kgeSe689vv5BRfSdoWSYmMnfWoVx3OoHQ/exec';
        // =========================================================

        let currentYear = '2026';
        let currentData = [], viewData = [], rawCot = [], filteredData = [];
        let sortDir = 1;
        
        // Variables Charts Globales
        let activeChartType = null, activeChartBar = null, activeChartTypeKg = null, activeChartBarKg = null;
        let evoChartUSD = null, evoChartKG = null;
        let chartCost = null, chartTime = null;

        // INICIALIZACIÃ“N
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('cotizador'); 
            updateEq(); 
            loadCot(); 
        });

        // --- NAVEGACIÃ“N ---
        function switchTab(tab) {
            // Ocultar vistas
            document.getElementById('view-cotizador').classList.add('hidden');
            document.getElementById('view-gestion').classList.add('hidden');
            document.getElementById('view-evolucion').classList.add('hidden');
            
            // Reset botones
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            if (tab === 'cotizador') {
                document.getElementById('view-cotizador').classList.remove('hidden');
                document.getElementById('btn-cotizador').classList.add('active');
                if(rawCot.length > 0) applyFilter();
            } else if (tab === 'evolucion') {
                document.getElementById('view-evolucion').classList.remove('hidden');
                document.getElementById('btn-evolucion').classList.add('active');
                loadEvolution();
            } else {
                // Es un aÃ±o (2026, 2025, 2024)
                currentYear = tab;
                document.getElementById('view-gestion').classList.remove('hidden');
                document.getElementById('btn-' + tab).classList.add('active');
                
                // Actualizar Textos
                document.getElementById('lbl-year').innerText = tab;
                document.getElementById('lbl-year-btn').innerText = tab;
                document.getElementById('lbl-year-modal').innerText = tab;
                
                loadData(tab);
            }
        }

        // --- FUNCIONES GESTIÃ“N DE DATOS ---
        function openImportModal() { document.getElementById('importModal').classList.remove('hidden'); document.getElementById('paste-area').value=''; document.getElementById('paste-area').focus(); }
        function closeModal() { document.getElementById('importModal').classList.add('hidden'); }
        function parseVal(s) { if(!s) return 0; let c = s.toString().replace(/[$\sA-Za-z]/g,''); if(c.indexOf(',')>-1 && c.indexOf('.')>-1) { if(c.lastIndexOf(',') > c.lastIndexOf('.')) c=c.replace(/\./g,'').replace(',','.'); else c=c.replace(/,/g,''); } else if(c.indexOf(',')>-1) c=c.replace(',','.'); return parseFloat(c)||0; }
        
        function saveData() {
            const txt = document.getElementById('paste-area').value;
            if(!txt) return;
            document.getElementById('loader').classList.remove('hidden');
            const rows = txt.split('\n');
            const data = [];
            rows.forEach(r => {
                const c = r.split('\t');
                if(c.length >= 13) {
                    let d = c[4]?.trim() || c[3]?.trim() || '';
                    data.push({ nroExpo: c[0]?.trim(), destino: c[1]?.trim(), tipo: c[2]?.trim(), fecha: d, sku: c[5]?.trim(), desc: c[6]?.trim(), kgNeto: parseVal(c[9]), precioTotal: parseVal(c[13]) });
                }
            });
            if(data.length > 0) {
                const fd = new FormData(); fd.append('action', 'save_pl'); fd.append('year', currentYear); fd.append('data', JSON.stringify(data));
                fetch(API_URL, { method: 'POST', body: fd }).then(r => r.json()).then(d => {
                    document.getElementById('loader').classList.add('hidden'); closeModal(); loadData(currentYear); alert(`âœ… Guardado en ${currentYear}`);
                });
            } else { alert("Datos invÃ¡lidos"); document.getElementById('loader').classList.add('hidden'); }
        }

        function loadData(year) {
            document.getElementById('loader').classList.remove('hidden');
            fetch(`${API_URL}?action=get_pl&year=${year}`).then(r => r.json()).then(d => {
                currentData = d || [];
                document.getElementById('db-status').innerText = `Registros: ${currentData.length}`;
                renderList();
                document.getElementById('loader').classList.add('hidden');
            }).catch(e => { console.log(e); document.getElementById('loader').classList.add('hidden'); });
        }

        // --- RENDERIZADO GESTION ---
        function renderList() {
            const sel = document.getElementById('pl-filter-dest');
            if(sel.options.length === 1 && currentData.length > 0) {
                const dests = [...new Set(currentData.map(i => i.destino).filter(x=>x))].sort();
                dests.forEach(d => { let o = document.createElement('option'); o.value=d; o.innerText=d; sel.appendChild(o); });
            }
            const filter = sel.value;
            const container = document.getElementById('pl-list');
            container.innerHTML = "";
            const groups = {};
            currentData.forEach(i => {
                if(filter !== 'TODOS' && i.destino !== filter) return;
                if(!i.nroExpo) return;
                if(!groups[i.nroExpo]) groups[i.nroExpo] = { id: i.nroExpo, dest: i.destino, total: 0 };
                groups[i.nroExpo].total += i.precioTotal;
            });
            const sumCard = document.createElement('div');
            sumCard.className = "bg-white p-3 rounded border border-blue-200 cursor-pointer mb-2 shadow-sm sticky top-0 flex justify-between items-center hover:bg-blue-50";
            sumCard.innerHTML = `<div class="font-bold text-blue-900"><i class="fa-solid fa-globe mr-2"></i>RESUMEN ${filter}</div><i class="fa-solid fa-chevron-right text-blue-300"></i>`;
            sumCard.onclick = () => renderView(filter, null);
            container.appendChild(sumCard);
            Object.values(groups).forEach(g => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded border border-gray-200 cursor-pointer mb-1 hover:bg-gray-50";
                div.onclick = () => renderView(filter, g.id);
                div.innerHTML = `<div class="flex justify-between font-bold text-xs text-gray-700"><span>${g.id}</span><span class="text-green-600">$${g.total.toLocaleString()}</span></div><div class="text-[10px] text-gray-400 mt-1">${g.dest}</div>`;
                container.appendChild(div);
            });
            renderView(filter, null);
        }

        function cleanName(n) { return n ? n.toUpperCase().replace(/^F-\s*|^HELADO\s+|^PINTA\s+/, '').trim() : "OTROS"; }
        function formatDate(d) { if(!d) return '-'; if(d.includes('-') && d.length===10) { const p=d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; } if(d.includes('T')) return d.split('T')[0]; return d; }

        function renderView(destFilter, expoId) {
            let data = currentData;
            if(destFilter !== 'TODOS') data = data.filter(i => i.destino === destFilter);
            if(expoId) {
                data = data.filter(i => i.nroExpo === expoId);
                document.getElementById('dash-title').innerText = `OperaciÃ³n: ${expoId}`;
                document.getElementById('dash-sub').innerText = "Detalle";
                document.getElementById('title-bar').innerText = "Top 5 SKUs";
            } else {
                document.getElementById('dash-title').innerText = `Resumen ${destFilter}`;
                document.getElementById('dash-sub').innerText = "Acumulado " + currentYear;
                document.getElementById('title-bar').innerText = "Top 5 Productos";
            }
            viewData = data;
            let tUSD = 0, tKG = 0;
            const byType = {}, byTypeKg = {}, byItem = {}, byItemKg = {};
            data.forEach(i => {
                tUSD += i.precioTotal; tKG += i.kgNeto;
                let type = i.tipo || "Otros";
                byType[type] = (byType[type]||0) + i.precioTotal; byTypeKg[type] = (byTypeKg[type]||0) + i.kgNeto;
                let key = expoId ? (i.desc || i.sku) : cleanName(i.desc);
                byItem[key] = (byItem[key]||0) + i.precioTotal; byItemKg[key] = (byItemKg[key]||0) + i.kgNeto;
            });
            document.getElementById('kpi-usd').innerText = `$ ${tUSD.toLocaleString('es-AR', {maximumFractionDigits:0})}`;
            document.getElementById('kpi-kg').innerText = `${tKG.toLocaleString('es-AR', {maximumFractionDigits:0})}`;
            document.getElementById('kpi-items').innerText = expoId ? data.length : new Set(data.map(x=>x.nroExpo)).size;
            renderTable();
            renderMgmtCharts(byType, byItem, byTypeKg, byItemKg);
        }

        function renderMgmtCharts(bt, bi, btk, bik) {
            [activeChartType, activeChartBar, activeChartTypeKg, activeChartBarKg].forEach(c => { if(c) c.destroy(); });
            const commonOpt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 9} } } } };
            const barOpt = { ...commonOpt, plugins: { legend: { display: false } }, indexAxis: 'y' };
            activeChartType = new Chart(document.getElementById('chartType'), { type: 'doughnut', data: { labels: Object.keys(bt), datasets: [{ data: Object.values(bt), backgroundColor: ['#1e3a8a','#f97316','#10b981','#6366f1'] }] }, options: commonOpt });
            const topI = Object.entries(bi).sort((a,b)=>b[1]-a[1]).slice(0,5);
            activeChartBar = new Chart(document.getElementById('chartBar'), { type: 'bar', data: { labels: topI.map(x=>x[0].substring(0,20)), datasets: [{ data: topI.map(x=>x[1]), backgroundColor: '#1e3a8a', borderRadius: 4 }] }, options: barOpt });
            activeChartTypeKg = new Chart(document.getElementById('chartTypeKg'), { type: 'doughnut', data: { labels: Object.keys(btk), datasets: [{ data: Object.values(btk), backgroundColor: ['#1e3a8a','#f97316','#10b981','#6366f1'] }] }, options: commonOpt });
            const topIK = Object.entries(bik).sort((a,b)=>b[1]-a[1]).slice(0,5);
            activeChartBarKg = new Chart(document.getElementById('chartBarKg'), { type: 'bar', data: { labels: topIK.map(x=>x[0].substring(0,20)), datasets: [{ data: topIK.map(x=>x[1]), backgroundColor: '#f97316', borderRadius: 4 }] }, options: barOpt });
        }

        function sortT(col) {
            sortDir *= -1;
            viewData.sort((a,b) => {
                let va = a[col==="desc"? "desc" : col==="sku"? "sku" : col==="tipo"? "tipo" : col==="fecha"? "fecha" : col==="kg"? "kgNeto" : "precioTotal"];
                let vb = b[col==="desc"? "desc" : col==="sku"? "sku" : col==="tipo"? "tipo" : col==="fecha"? "fecha" : col==="kg"? "kgNeto" : "precioTotal"];
                if(col==="kg" || col==="usd") return sortDir * (va - vb);
                return sortDir * String(va).localeCompare(String(vb));
            });
            renderTable();
        }

        function renderTable() {
            const tb = document.getElementById('pl-table');
            tb.innerHTML = "";
            viewData.slice(0, 100).forEach(i => {
                tb.innerHTML += `<tr class="bg-white border-b clickable-row text-xs transition"><td class="p-2 font-mono text-gray-500">${formatDate(i.fecha)}</td><td class="p-2 font-mono text-blue-900">${i.sku}</td><td class="p-2 truncate max-w-xs font-bold" title="${i.desc}">${i.desc}</td><td class="p-2"><span class="bg-blue-50 text-blue-700 px-1 rounded">${i.tipo}</span></td><td class="p-2 text-right">${i.kgNeto.toLocaleString()}</td><td class="p-2 text-right font-bold text-green-700">$${i.precioTotal.toLocaleString()}</td></tr>`;
            });
        }

        function searchSKU() {
            const t = document.getElementById('skuInput').value.toLowerCase();
            const panel = document.getElementById('search-results');
            if(t.length < 2) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            const matches = currentData.filter(i => (String(i.sku).toLowerCase().includes(t)) || (String(i.desc).toLowerCase().includes(t)) || (String(i.nroExpo).toLowerCase().includes(t)));
            const b = document.getElementById('search-body'); b.innerHTML = "";
            if(matches.length === 0) b.innerHTML = `<tr><td colspan="6" class="p-4 text-center">Sin resultados</td></tr>`;
            else matches.slice(0, 50).forEach(i => {
                b.innerHTML += `<tr class="bg-white border-b hover:bg-blue-50 cursor-pointer" onclick="goToOp('${i.nroExpo}','${i.destino}')"><td class="p-2 text-xs">${formatDate(i.fecha)}</td><td class="p-2 text-xs font-bold">${i.nroExpo}</td><td class="p-2 text-xs">${i.destino}</td><td class="p-2 text-xs">${i.sku}</td><td class="p-2 text-xs">${i.desc}</td><td class="p-2 text-xs text-right">${i.kgNeto}</td></tr>`;
            });
        }
        function closeSearch() { document.getElementById('search-results').classList.add('hidden'); document.getElementById('skuInput').value = ""; }
        function goToOp(id, dest) { closeSearch(); const s = document.getElementById('pl-filter-dest'); if(s.querySelector(`option[value="${dest}"]`)) s.value = dest; else s.value = 'TODOS'; renderList(); renderView(s.value === 'TODOS' ? 'TODOS' : dest, id); }

        // --- EVOLUCIÃ“N MENSUAL ---
        function getMonthFromDate(dStr) {
            if(!dStr) return -1;
            if(dStr.includes('-')) return parseInt(dStr.split('-')[1]) - 1; 
            if(dStr.includes('/')) return parseInt(dStr.split('/')[1]) - 1; 
            const dObj = new Date(dStr);
            if(!isNaN(dObj)) return dObj.getMonth();
            return -1;
        }

        function loadEvolution() {
            document.getElementById('loader').classList.remove('hidden');
            fetch(`${API_URL}?action=get_all_years`).then(r => r.json()).then(data => {
                const years = Object.keys(data).sort();
                const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const seriesUSD = {}, seriesKG = {}, totals = {};
                years.forEach(y => {
                    seriesUSD[y] = Array(12).fill(0); seriesKG[y] = Array(12).fill(0); let yUSD = 0, yKG = 0;
                    data[y].forEach(i => { const m = getMonthFromDate(i.fecha); if(m >= 0 && m < 12) { seriesUSD[y][m] += i.precioTotal; seriesKG[y][m] += i.kgNeto; yUSD += i.precioTotal; yKG += i.kgNeto; } });
                    totals[y] = { usd: yUSD, kg: yKG };
                });
                
                if(evoChartUSD) evoChartUSD.destroy(); if(evoChartKG) evoChartKG.destroy();
                
                const createConfig = (dataset, label) => ({ type: 'line', data: { labels: months, datasets: years.map((y, idx) => ({ label: y, data: dataset[y], borderColor: idx===0?'#94a3b8':idx===1?'#3b82f6':'#16a34a', backgroundColor: 'transparent', tension: 0.3, borderWidth: 3 })) }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
                
                evoChartUSD = new Chart(document.getElementById('evoChartUSD'), createConfig(seriesUSD, 'USD'));
                evoChartKG = new Chart(document.getElementById('evoChartKG'), createConfig(seriesKG, 'KG'));
                
                const tb = document.getElementById('evoTableBody'); tb.innerHTML = "";
                years.forEach(y => { let am = seriesUSD[y].filter(v => v > 0).length || 1; tb.innerHTML += `<tr class="bg-white border-b"><td class="p-3 font-bold">${y}</td><td class="p-3 text-right font-mono text-green-700">$${totals[y].usd.toLocaleString()}</td><td class="p-3 text-right font-mono">${totals[y].kg.toLocaleString()}</td><td class="p-3 text-right text-gray-500">$${(totals[y].usd / am).toLocaleString('es-AR', {maximumFractionDigits:0})}</td></tr>`; });
                document.getElementById('loader').classList.add('hidden');
            }).catch(e=>{console.log(e); document.getElementById('loader').classList.add('hidden');});
        }

        function downloadExcelPL() {
            if(!viewData.length) { alert("Sin datos"); return; }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(viewData.map(i => ({ "Fecha": formatDate(i.fecha), "Op": i.nroExpo, "Dest": i.destino, "SKU": i.sku, "Desc": i.desc, "Tipo": i.tipo, "Kg": i.kgNeto, "USD": i.precioTotal })));
            XLSX.utils.book_append_sheet(wb, ws, "Reporte_" + currentYear);
            XLSX.writeFile(wb, `Reporte_Freddo_${currentYear}.xlsx`);
        }

        // --- COTIZADOR (RESTAURADO) ---
        const eqOpts = {"MarÃ­timo":["20' STD","40' STD","40' HC","20' Reefer","40' Reefer"],"Terrestre":["CamiÃ³n FTL","Sider","FurgÃ³n"],"AÃ©reo":["General","Perecedera"]};
        function updateEq() { const m=document.getElementById('modalidadSelect').value; const s=document.getElementById('equipoSelect'); s.innerHTML=""; eqOpts[m].forEach(o=>{let e=document.createElement("option");e.value=o;e.innerText=o;s.appendChild(e)}); }
        document.getElementById('comexForm').addEventListener('submit',e=>{e.preventDefault();fetch(API_URL,{method:'POST',body:new FormData(e.target)}).then(r=>r.json()).then(d=>{alert('Guardado');loadCot();});});
        
        async function loadCot() { 
            try{ const r=await fetch(API_URL); const d=await r.json(); rawCot=d||[]; applyFilter(); } catch(e){} 
        }
        
        function applyFilter() {
            const c=document.getElementById('filterCountry').value; 
            filteredData=(c==="ALL")?rawCot:rawCot.filter(r=>r[2]===c);
            let tc=0,tt=0,ct=0,st={};
            if(filteredData.length>0){
                filteredData.forEach(r=>{
                    let k=(c==="ALL")?(r[2]||"S/D"):(r[6]||"S/D");
                    let co=(parseFloat(r[8])||0)+(parseFloat(r[9])||0);
                    let t=parseFloat(r[7])||0;
                    if(!st[k])st[k]={cs:0,ts:0,c:0}; st[k].cs+=co;st[k].ts+=t;st[k].c++; tc+=co; if(t>0){tt+=t;ct++;}
                });
                document.getElementById('kpiCount').innerText=filteredData.length;
                document.getElementById('kpiAvgCost').innerText=filteredData.length?`$${(tc/filteredData.length).toFixed(0)}`:"0";
                document.getElementById('kpiAvgTime').innerText=ct?(tt/ct).toFixed(1)+"d":"-";
                let top=Object.keys(st).length?Object.keys(st).reduce((a,b)=>st[a].c>st[b].c?a:b):'-';
                document.getElementById('kpiTop').innerText=top;
                renderCotCharts(Object.keys(st), Object.keys(st).map(k=>(st[k].cs/st[k].c).toFixed(0)), Object.keys(st).map(k=>(st[k].ts/st[k].c).toFixed(1)), c!=="ALL");
            }
            renderCotTable();
        }

        function renderCotCharts(l,c,t,isC){
            if(chartCost)chartCost.destroy(); if(chartTime)chartTime.destroy();
            const o={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}};
            chartCost=new Chart(document.getElementById('costChart'),{type:'bar',data:{labels:l,datasets:[{label:'USD',data:c,backgroundColor:isC?'#f97316':'#1e3a8a',borderRadius:4}]},options:o});
            chartTime=new Chart(document.getElementById('timeChart'),{type:'line',data:{labels:l,datasets:[{label:'DÃ­as',data:t,borderColor:'#4f46e5',backgroundColor:'rgba(79,70,229,0.1)',fill:true}]},options:o});
        }

        function renderCotTable() {
            const tb=document.getElementById('historyTableBody'); tb.innerHTML="";
            if(filteredData.length>0) filteredData.slice().reverse().slice(0,50).forEach(r=>{
                let d=r[0]?new Date(r[0]).toLocaleDateString():'-';
                tb.innerHTML+=`<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-2">${d}</td><td class="px-4 py-2 font-bold text-xs">${r[1]||''}</td><td class="px-4 py-2">${r[2]||''}</td><td class="px-4 py-2 text-xs truncate max-w-[100px]">${r[6]||''}</td><td class="px-4 py-2 text-right font-bold text-green-700">$${((parseFloat(r[8])||0)+(parseFloat(r[9])||0)).toFixed(2)}</td></tr>`;
            });
        }
    </script>
</body>
</html>
