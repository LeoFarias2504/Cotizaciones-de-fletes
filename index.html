<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freddo Comex - Dashboard Log√≠stico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .freddo-blue { background-color: #003366; }
        .freddo-text { color: #003366; }
        .card-gradient { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <nav class="freddo-blue p-4 shadow-xl mb-8">
        <div class="container mx-auto flex justify-between items-center text-white">
            <h1 class="font-bold text-xl tracking-tighter italic">FREDDO <span class="text-blue-300 font-light underline">COMEX ANALYTICS</span></h1>
            <div class="flex gap-4 opacity-80">
                <i class="fas fa-ship"></i>
                <i class="fas fa-truck"></i>
                <i class="fas fa-plane"></i>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 grid grid-cols-1 lg:grid-cols-4 gap-8 pb-12">
        
        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-3xl shadow-2xl border-t-8 border-blue-600 sticky top-4">
                <h2 class="freddo-text font-black text-xs uppercase mb-6 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i> Cargar Nueva Cotizaci√≥n
                </h2>
                <form id="formComex" class="space-y-4">
                    <input type="text" name="referencia" placeholder="Ref. Expo (Ej: EXP-101)" class="w-full p-3 bg-slate-50 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                    <input type="text" name="destino" placeholder="Puerto / Ciudad Destino" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none" required>
                    
                    <select name="modalidad" class="w-full p-3 bg-slate-50 border rounded-xl text-sm cursor-pointer">
                        <option value="Mar√≠timo">üö¢ Mar√≠timo</option>
                        <option value="Terrestre">üöõ Terrestre</option>
                        <option value="A√©reo">‚úàÔ∏è A√©reo</option>
                    </select>

                    <input type="text" name="carrier" placeholder="Naviera / Transportista" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" required>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Transit Time</label>
                            <input type="number" name="transit_time" placeholder="D√≠as" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Flete USD</label>
                            <input type="number" step="0.01" name="flete" placeholder="Monto" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" required>
                        </div>
                    </div>
                    <input type="number" step="0.01" name="gastos_locales" placeholder="Gastos Locales (USD)" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" required>

                    <button type="submit" id="btnSave" class="w-full bg-[#003366] text-white font-bold py-4 rounded-2xl hover:bg-blue-800 transition shadow-lg transform hover:-translate-y-1">
                        GUARDAR EN EXCEL
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-3 space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-md border-l-8 border-blue-500 card-gradient">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Promedio Flete</p>
                    <h3 class="text-3xl font-black freddo-text" id="kpiAvgFlete">USD 0.00</h3>
                    <i class="fas fa-file-invoice-dollar float-right opacity-10 text-4xl -mt-8"></i>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-md border-l-8 border-indigo-500 card-gradient">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Avg. Transit Time</p>
                    <h3 class="text-3xl font-black freddo-text" id="kpiAvgTime">0 D√≠as</h3>
                    <i class="fas fa-clock float-right opacity-10 text-4xl -mt-8"></i>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-md border-l-8 border-cyan-500 card-gradient">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Total Operaciones</p>
                    <h3 class="text-3xl font-black freddo-text" id="kpiTotal">0</h3>
                    <i class="fas fa-boxes-stacked float-right opacity-10 text-4xl -mt-8"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                    <h4 class="text-slate-500 font-bold text-[10px] uppercase mb-6 flex items-center gap-2 tracking-widest">
                        <i class="fas fa-map-marked-alt text-blue-500"></i> An√°lisis por Destino
                    </h4>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                    <h4 class="text-slate-500 font-bold text-[10px] uppercase mb-6 flex items-center gap-2 tracking-widest">
                        <i class="fas fa-truck-moving text-blue-500"></i> Mix de Transporte
                    </h4>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        // TU URL DE GOOGLE APPS SCRIPT
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxg3ZiHoRNF64b-y_yGe_FpVmyuA9uqt_yrutnMGxFKghy1eXPhz0GLpHIHXw7IJm01YA/exec';

        // FUNCI√ìN PARA CARGAR DATOS DESDE EL EXCEL
        async function loadDashboard() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (!data || data.length === 0) return;

                // 1. C√°lculos de KPIs
                const totalOperaciones = data.length;
                const totalFlete = data.reduce((acc, row) => acc + (parseFloat(row[8]) || 0), 0);
                const totalTime = data.reduce((acc, row) => acc + (parseInt(row[7]) || 0), 0);
                
                document.getElementById('kpiTotal').innerText = totalOperaciones;
                document.getElementById('kpiAvgFlete').innerText = 'USD ' + (totalFlete / totalOperaciones).toFixed(2);
                document.getElementById('kpiAvgTime').innerText = Math.round(totalTime / totalOperaciones) + ' D√≠as';

                // 2. Procesar Gr√°fico de Barras (Costos por Destino)
                const destinosData = {};
                data.forEach(row => {
                    const dest = row[2]; // Columna C: Destino
                    const costo = parseFloat(row[8]) || 0; // Columna I: Flete
                    if (!destinosData[dest]) destinosData[dest] = { suma: 0, cant: 0 };
                    destinosData[dest].suma += costo;
                    destinosData[dest].cant++;
                });

                const labelsDest = Object.keys(destinosData);
                const valoresDest = labelsDest.map(l => (destinosData[l].suma / destinosData[l].cant).toFixed(0));

                renderBarChart(labelsDest, valoresDest);

                // 3. Procesar Gr√°fico de Torta (Modalidades)
                const mods = { 'Mar√≠timo': 0, 'Terrestre': 0, 'A√©reo': 0 };
                data.forEach(row => {
                    const m = row[3]; // Columna D: Modalidad
                    if (mods.hasOwnProperty(m)) mods[m]++;
                });

                renderPieChart(Object.keys(mods), Object.values(mods));

            } catch (error) {
                console.error("Todav√≠a no hay datos cargados o la URL es incorrecta.");
            }
        }

        // RENDERIZAR GR√ÅFICO DE BARRAS
        function renderBarChart(labels, values) {
            new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Flete Promedio (USD)',
                        data: values,
                        backgroundColor: '#003366',
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        // RENDERIZAR GR√ÅFICO DE TORTA
        function renderPieChart(labels, values) {
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#003366', '#3b82f6', '#94a3b8'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, cutout: '70%' }
            });
        }

        // GUARDAR DATOS DEL FORMULARIO
        document.getElementById('formComex').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.innerText = 'GUARDANDO...';

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: new FormData(e.target) });
                alert('¬°Cotizaci√≥n guardada exitosamente!');
                location.reload(); // Recarga la p√°gina para actualizar el Dashboard
            } catch (err) {
                alert('Error al guardar. Verifica la conexi√≥n.');
                btn.disabled = false;
                btn.innerText = 'GUARDAR EN EXCEL';
            }
        });

        // INICIALIZAR DASHBOARD AL CARGAR
        loadDashboard();
    </script>
</body>
</html>
